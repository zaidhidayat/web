<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PJ BATUR</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(90deg, #003366, #ffffff, #d4af37, #003366);
    color: #003366;
  }
  #app {
    max-width: 100vw;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    width: 100%;
    background: linear-gradient(90deg, #003366, #d4af37, #003366);
    color: white;
    padding: 1rem 1.5rem;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  header h1 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
  }
  header h2 {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 400;
    opacity: 0.8;
  }
  /* Hamburger */
  .hamburger {
    width: 30px;
    height: 22px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .hamburger div {
    height: 4px;
    background: white;
    border-radius: 2px;
  }
  /* Sidebar menu */
  nav {
    position: fixed;
    top: 0; right: 0;
    height: 100vh;
    width: 250px;
    background: #003366cc;
    color: white;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    padding-top: 4rem;
    z-index: 1000;
  }
  nav.open {
    transform: translateX(0);
  }
  nav ul {
    list-style: none;
    padding: 0 1rem;
    margin: 0;
  }
  nav ul li {
    margin: 1rem 0;
  }
  nav ul li button {
    background: none;
    border: none;
    color: white;
    font-size: 1.1rem;
    width: 100%;
    text-align: left;
    cursor: pointer;
    padding: 0.5rem 0;
    font-weight: 600;
    border-bottom: 1px solid #d4af37;
    transition: background 0.2s ease;
  }
  nav ul li button:hover {
    background: #d4af37;
    color: #003366;
  }
  main {
    flex-grow: 1;
    width: 100%;
    max-width: 100vw;
    background: white;
    padding: 1rem 1.5rem;
    overflow-y: auto;
  }
  /* Images */
  .page-image {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 0 10px #d4af37aa;
  }
  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    box-shadow: 0 0 10px #d4af37aa;
  }
  th, td {
    border: 1px solid #003366;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }
  th {
    background: #d4af37;
    color: #003366;
    font-weight: 700;
  }
  td.center {
    text-align: center;
  }
  /* Buttons */
  button.action-btn {
    background: #d4af37;
    border: none;
    color: #003366;
    font-weight: 700;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    box-shadow: 0 0 8px #d4af37aa;
    transition: background 0.3s ease;
  }
  button.action-btn:hover {
    background: #b38f1f;
  }
  /* Form inputs */
  input[type="text"], input[type="file"] {
    padding: 0.5rem;
    font-size: 1rem;
    border: 1px solid #003366;
    border-radius: 4px;
    width: 100%;
    max-width: 300px;
    margin-bottom: 1rem;
  }
  /* CT Dengan Gambar preview */
  #ct-image-preview {
    max-width: 100%;
    max-height: 300px;
    margin-top: 1rem;
    border-radius: 8px;
    box-shadow: 0 0 10px #d4af37aa;
  }
  #whatsapp-preview {
    margin-top: 1rem;
    white-space: pre-wrap;
    font-family: monospace;
    background: #f0f0f0;
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    max-width: 600px;
  }
  /* Scrollbar for main */
  main::-webkit-scrollbar {
    width: 8px;
  }
  main::-webkit-scrollbar-thumb {
    background: #d4af37;
    border-radius: 4px;
  }
  main::-webkit-scrollbar-track {
    background: #f0f0f0;
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div>
      <h1 id="page-title">Patroli ROW</h1>
      <h2>PJ BATUR</h2>
    </div>
    <div class="hamburger" id="hamburger" aria-label="Menu" role="button" tabindex="0">
      <div></div><div></div><div></div>
    </div>
  </header>
  <nav id="sidebar" aria-label="Main menu">
    <ul>
      <li><button data-page="patroli">Patroli ROW</button></li>
      <li><button data-page="jadwal">Jadwal Piket</button></li>
      <li><button data-page="urban">Urban</button></li>
      <li><button data-page="mandorline">Mandorline</button></li>
      <li><button data-page="pemadaman">Pemadaman</button></li>
      <li><button data-page="kct">KCT</button></li>
      <li><button data-page="vkrn">VKRN</button></li>
      <li><button data-page="ctgambar">CT Dengan Gambar</button></li>
      <li><button data-page="ctmanual">CT Manual</button></li>
      <li><button data-page="k3">K3</button></li>
    </ul>
  </nav>
  <main id="content" tabindex="0">
    <!-- Content loaded by JS -->
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
  const hamburger = document.getElementById('hamburger');
  const sidebar = document.getElementById('sidebar');
  const content = document.getElementById('content');
  const pageTitle = document.getElementById('page-title');

  // Pages content functions
  const pages = {
    patroli: () => {
      pageTitle.textContent = 'Patroli ROW';
      return `<img src="patroli.jpg" alt="Patroli ROW" class="page-image" />`;
    },
    jadwal: () => {
      pageTitle.textContent = 'Jadwal Piket';
      return `<img src="jadwal.jpg" alt="Jadwal Piket" class="page-image" />`;
    },
    urban: async () => {
      pageTitle.textContent = 'Urban';
      const data = await fetchCSV('urban.csv');
      return renderTable(data, [2,3]);
    },
    mandorline: async () => {
      pageTitle.textContent = 'Mandorline';
      const data = await fetchCSV('mandorline.csv');
      return renderTable(data);
    },
    pemadaman: async () => {
      pageTitle.textContent = 'Pemadaman';
      const data = await fetchCSV('pemadaman.csv');
      return renderTable(data);
    },
    kct: () => {
      pageTitle.textContent = 'KCT';
      return `<button class="action-btn" id="btn-kct">Buka KCT</button>`;
    },
    vkrn: () => {
      pageTitle.textContent = 'VKRN';
      return `<button class="action-btn" id="btn-vkrn">Buka VKRN</button>`;
    },
    ctgambar: () => {
      pageTitle.textContent = 'CT Dengan Gambar';
      return `
        <input type="file" id="upload-image" accept="image/*" />
        <img id="ct-image-preview" alt="Preview Gambar" style="display:none;" />
        <div id="whatsapp-preview"></div>
        <button class="action-btn" id="btn-send-whatsapp" style="display:none;">Send WhatsApp</button>
      `;
    },
    ctmanual: () => {
      pageTitle.textContent = 'CT Manual';
      return `
        <input type="text" id="input-meter" placeholder="Nomor Meter" />
        <input type="text" id="input-g" placeholder="Nomor G" />
        <button class="action-btn" id="btn-send-whatsapp-manual">Send WhatsApp</button>
      `;
    },
    k3: () => {
      pageTitle.textContent = 'K3';
      return `
        <p>Melakukan Safety Briefing sebelum memulai pekerjaan</p>
        <p>Melakukan pekerjaan berdasar dokumen Working Permit</p>
        <p>Membuat dan memahami identifikasi bahaya, pengendalian resiko dan JSA pada setiap pekerjaan</p>
        <p>Memahami dan melakukan pekerjaan sesuai dengan langkah dan tahapan SOP</p>
        <p>Memahami dan melakukan alat pelindung diri sesuai SOP</p>
        <p>Bekerja menggunakan alat kerja sesuai SOP</p>
        <p>Melakukan cek tegangan menggunakan volt detector</p>
        <p>Melakukan pemasangan grounding pada kedua sisi sesuai SOP</p>
        <p>Memasang Rambu atau Lotto pada saat melaksanakan pekerjaan</p>
        <p>Saling mengingatkan rekan kerja yang berada pada kondisi berbahaya saat bekerja</p>
        <p>Tidak melanjutkan pekerjaan apabila tidak ada pengawas, working permit/work order SOP, JSA, APD dan Alat Kerja.</p>
      `;
    }
  };

  // Hamburger toggle
  hamburger.addEventListener('click', () => {
    sidebar.classList.toggle('open');
  });
  // Close sidebar on outside click
  document.addEventListener('click', e => {
    if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
      sidebar.classList.remove('open');
    }
  });

  // Navigation buttons
  sidebar.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async () => {
      sidebar.classList.remove('open');
      const page = btn.dataset.page;
      if (pages[page]) {
        if (page === 'urban' || page === 'mandorline' || page === 'pemadaman') {
          content.innerHTML = '<p>Loading...</p>';
          content.innerHTML = await pages[page]();
        } else {
          content.innerHTML = pages[page]();
        }
        attachPageEvents(page);
        content.focus();
      }
    });
  });

  // Initial load
  (async () => {
    content.innerHTML = await pages.patroli();
  })();

  // Fetch CSV and parse
  async function fetchCSV(filename) {
    try {
      const res = await fetch(filename);
      const text = await res.text();
      return parseCSV(text);
    } catch {
      return [];
    }
  }
  // Simple CSV parser
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    return lines.map(line => {
      // Split by comma, handle quoted commas
      const regex = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g;
      const matches = line.match(regex);
      return matches ? matches.map(s => s.replace(/^"|"$/g, '')) : [];
    });
  }
  // Render table with optional center alignment for cols (0-based)
  function renderTable(data, centerCols=[]) {
    if (!data.length) return '<p>Tidak ada data.</p>';
    let html = '<table><thead><tr>';
    data[0].forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';
    for(let i=1; i<data.length; i++) {
      html += '<tr>';
      data[i].forEach((cell, idx) => {
        const cls = centerCols.includes(idx) ? 'center' : '';
        html += `<td class="${cls}">${cell}</td>`;
      });
      html += '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }

  // Attach events for special pages
  function attachPageEvents(page) {
    if (page === 'kct') {
      document.getElementById('btn-kct').onclick = () => {
        window.open('https://pdpjpwt.my.id/', '_blank');
      };
    }
    if (page === 'vkrn') {
      document.getElementById('btn-vkrn').onclick = () => {
        window.open('https://tewbo.my.id/', '_blank');
      };
    }
    if (page === 'ctgambar') {
      const uploadInput = document.getElementById('upload-image');
      const imgPreview = document.getElementById('ct-image-preview');
      const whatsappPreview = document.getElementById('whatsapp-preview');
      const btnSend = document.getElementById('btn-send-whatsapp');
      let lastText = '';
      let nomerMeter = '';
      let nomerG = '';

      uploadInput.onchange = async e => {
        whatsappPreview.textContent = '';
        btnSend.style.display = 'none';
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        imgPreview.src = url;
        imgPreview.style.display = 'block';

        whatsappPreview.textContent = 'Memproses OCR...';
        const { data: { text } } = await Tesseract.recognize(file, 'ind', { logger: m => {} });
        // Cari nomer meter (angka mulai 52205) dan nomer g (G diikuti angka)
        const meterMatch = text.match(/52205\d*/);
        const gMatch = text.match(/G\d+/i);
        nomerMeter = meterMatch ? meterMatch[0] : '';
        nomerG = gMatch ? gMatch[0].toUpperCase() : '';
        lastText = `FORMAT PERMINTAAN CLEAR TEMPER\n\nID Pelanggan/Nomor Meter : ${nomerMeter}\nNomor gangguan/PK : ${nomerG}\nKeterangan: kwh meter periksa.`;
        whatsappPreview.textContent = lastText;
        if (nomerMeter && nomerG) {
          btnSend.style.display = 'inline-block';
        } else {
          btnSend.style.display = 'none';
        }
      };
      btnSend.onclick = () => {
        const msg = encodeURIComponent(lastText);
        window.open(`https://wa.me/?text=${msg}`, '_blank');
      };
    }
    if (page === 'ctmanual') {
      const btnSendManual = document.getElementById('btn-send-whatsapp-manual');
      btnSendManual.onclick = () => {
        const meter = document.getElementById('input-meter').value.trim();
        const g = document.getElementById('input-g').value.trim();
        if (!meter || !g) {
          alert('Mohon isi Nomor Meter dan Nomor G');
          return;
        }
        const msg = `FORMAT PERMINTAAN CLEAR TEMPER\n\nID Pelanggan/Nomor Meter : ${meter}\nNomor gangguan/PK : ${g}\nKeterangan: kwh meter periksa.`;
        const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
      };
    }
  }
</script>
</body>
</html>
