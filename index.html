<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PJ BATUR</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(90deg, #003366, #ffffff, #d4af37, #003366);
    color: #003366;
    height: 100vh;
    overflow-x: hidden;
  }
  #app {
    max-width: 100%;
    margin: 0 auto;
  }
  header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 70px;
    background: linear-gradient(90deg, #003366, #d4af37, #003366);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1rem;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }
  header .titles {
    display: flex;
    flex-direction: column;
    line-height: 1;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
  }
  header h2 {
    margin: 0;
    font-size: 0.8rem;
    font-weight: 400;
    opacity: 0.8;
  }
  /* Hamburger menu */
  .hamburger {
    cursor: pointer;
    width: 30px;
    height: 22px;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .hamburger span {
    display: block;
    height: 4px;
    background: white;
    border-radius: 2px;
  }
  nav {
    position: fixed;
    top: 70px;
    right: -250px;
    width: 250px;
    height: calc(100% - 70px);
    background: #003366cc;
    color: white;
    transition: right 0.3s ease;
    padding-top: 1rem;
    z-index: 999;
    overflow-y: auto;
  }
  nav.open {
    right: 0;
  }
  nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  nav li {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #d4af37;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.1rem;
  }
  nav li:hover {
    background: #d4af37;
    color: #003366;
  }
  main {
    margin-top: 70px;
    padding: 1rem 1.5rem;
    max-width: 100%;
    min-height: calc(100vh - 70px);
    background: white;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
  }
  /* Images */
  main img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
    border-radius: 8px;
    box-shadow: 0 0 10px #d4af37aa;
  }
  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.9rem;
  }
  th, td {
    border: 1px solid #003366;
    padding: 0.5rem 0.75rem;
    text-align: left;
  }
  th {
    background: linear-gradient(90deg, #003366, #d4af37);
    color: white;
  }
  /* Special center alignment for col 3 & 4 in Urban */
  .urban-table td:nth-child(3),
  .urban-table td:nth-child(4),
  .urban-table th:nth-child(3),
  .urban-table th:nth-child(4) {
    text-align: center;
  }
  /* Buttons */
  button {
    background: linear-gradient(90deg, #003366, #d4af37);
    border: none;
    color: white;
    padding: 0.7rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 25px;
    cursor: pointer;
    box-shadow: 0 0 10px #d4af37aa;
    transition: background 0.3s ease;
    margin: 1rem auto;
    display: block;
  }
  button:hover {
    background: linear-gradient(90deg, #d4af37, #003366);
  }
  /* CT Dengan Gambar */
  #ct-gambar-container {
    text-align: center;
  }
  #ct-gambar-container img {
    max-width: 300px;
    margin-top: 1rem;
    border-radius: 8px;
    box-shadow: 0 0 10px #003366aa;
  }
  #ct-gambar-container pre {
    background: #f0f0f0;
    border-radius: 6px;
    padding: 0.5rem;
    margin: 0.5rem auto;
    max-width: 90%;
    white-space: pre-wrap;
    word-wrap: break-word;
    box-shadow: inset 0 0 5px #d4af37aa;
  }
  /* CT Manual */
  #ct-manual-form {
    max-width: 400px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  #ct-manual-form input {
    padding: 0.5rem 0.75rem;
    font-size: 1rem;
    border: 1px solid #003366;
    border-radius: 6px;
  }
  /* K3 text */
  #k3-text {
    max-width: 600px;
    margin: 0 auto;
    font-size: 1rem;
    line-height: 1.5;
    font-weight: 600;
  }
  /* Scrollbar for nav */
  nav::-webkit-scrollbar {
    width: 8px;
  }
  nav::-webkit-scrollbar-thumb {
    background: #d4af37;
    border-radius: 4px;
  }
</style>
</head>
<body>
<header>
  <div class="titles">
    <h1 id="page-title">Patroli ROW</h1>
    <h2>PJ BATUR</h2>
  </div>
  <div class="hamburger" id="hamburger" aria-label="Menu" role="button" tabindex="0">
    <span></span><span></span><span></span>
  </div>
</header>
<nav id="nav-menu" aria-label="Main menu">
  <ul>
    <li data-page="patroli">Patroli ROW</li>
    <li data-page="jadwal">Jadwal Piket</li>
    <li data-page="urban">Urban</li>
    <li data-page="mandorline">Mandorline</li>
    <li data-page="pemadaman">Pemadaman</li>
    <li data-page="kct">KCT</li>
    <li data-page="vkrn">VKRN</li>
    <li data-page="ct-gambar">CT Dengan Gambar</li>
    <li data-page="ct-manual">CT Manual</li>
    <li data-page="k3">K3</li>
  </ul>
</nav>
<main id="main-content" role="main" aria-live="polite" aria-atomic="true" tabindex="0">
  <!-- Content loaded by JS -->
</main>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script>
  const pages = {
    patroli: {
      title: "Patroli ROW",
      content: () => {
        return `<img src="patroli.jpg" alt="Patroli ROW" />`;
      }
    },
    jadwal: {
      title: "Jadwal Piket",
      content: () => {
        return `<img src="jadwal.jpg" alt="Jadwal Piket" />`;
      }
    },
    urban: {
      title: "Urban",
      content: async () => {
        const data = await fetchCSV('urban.csv');
        return renderTable(data, true);
      }
    },
    mandorline: {
      title: "Mandorline",
      content: async () => {
        const data = await fetchCSV('mandorline.csv');
        return renderTable(data, false);
      }
    },
    pemadaman: {
      title: "Pemadaman",
      content: async () => {
        const data = await fetchCSV('pemadaman.csv');
        return renderTable(data, false);
      }
    },
    kct: {
      title: "KCT",
      content: () => {
        return `<button id="btn-kct" type="button">Buka KCT</button>`;
      }
    },
    vkrn: {
      title: "VKRN",
      content: () => {
        return `<button id="btn-vkrn" type="button">Buka VKRN</button>`;
      }
    },
    "ct-gambar": {
      title: "CT Dengan Gambar",
      content: () => {
        return `
          <div id="ct-gambar-container">
            <input type="file" id="upload-image" accept="image/*" />
            <button id="btn-send-whatsapp" disabled>Send WhatsApp</button>
            <pre id="ocr-process"></pre>
            <pre id="search-result"></pre>
            <img id="preview-image" alt="Preview" />
          </div>
        `;
      }
    },
    "ct-manual": {
      title: "CT Manual",
      content: () => {
        return `
          <form id="ct-manual-form" onsubmit="return false;">
            <input type="text" id="input-meter" placeholder="Nomor Meter" required />
            <input type="text" id="input-g" placeholder="Nomor G" required />
            <button id="btn-send-whatsapp-manual" type="button">Send WhatsApp</button>
          </form>
        `;
      }
    },
    k3: {
      title: "K3",
      content: () => {
        return `
          <div id="k3-text">
            <p>Melakukan Safety Briefing sebelum memulai pekerjaan</p>
            <p>Melakukan pekerjaan berdasar dokumen Working Permit</p>
            <p>Membuat dan memahami identifikasi bahaya, pengendalian resiko dan JSA pada setiap pekerjaan</p>
            <p>Memahami dan melakukan pekerjaan sesuai dengan langkah dan tahapan SOP</p>
            <p>Memahami dan melakukan alat pelindung diri sesuai SOP</p>
            <p>Bekerja menggunakan alat kerja sesuai SOP</p>
            <p>Melakukan cek tegangan menggunakan volt detector</p>
            <p>Melakukan pemasangan grounding pada kedua sisi sesuai SOP</p>
            <p>Memasang Rambu atau Lotto pada saat melaksanakan pekerjaan</p>
            <p>Saling mengingatkan rekan kerja yang berada pada kondisi berbahaya saat bekerja</p>
            <p>Tidak melanjutkan pekerjaan apabila tidak ada pengawas, working permit/work order SOP, JSA, APD dan Alat Kerja</p>
          </div>
        `;
      }
    }
  };

  // Hamburger toggle
  const hamburger = document.getElementById('hamburger');
  const navMenu = document.getElementById('nav-menu');
  hamburger.addEventListener('click', () => {
    navMenu.classList.toggle('open');
  });
  hamburger.addEventListener('keydown', e => {
    if(e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      navMenu.classList.toggle('open');
    }
  });

  // Navigation click
  navMenu.querySelectorAll('li').forEach(li => {
    li.addEventListener('click', async () => {
      navMenu.classList.remove('open');
      await loadPage(li.dataset.page);
    });
  });

  // Load page content
  async function loadPage(pageKey) {
    const page = pages[pageKey];
    if (!page) return;
    document.getElementById('page-title').textContent = page.title;
    const main = document.getElementById('main-content');
    main.innerHTML = 'Loading...';
    let content = page.content();
    if (content instanceof Promise) {
      content = await content;
    }
    main.innerHTML = content;
    if(pageKey === 'kct') {
      document.getElementById('btn-kct').onclick = () => {
        window.open('https://pdpjpwt.my.id/', '_blank');
      };
    }
    if(pageKey === 'vkrn') {
      document.getElementById('btn-vkrn').onclick = () => {
        window.open('https://tewbo.my.id/', '_blank');
      };
    }
    if(pageKey === 'ct-gambar') {
      setupCTGambar();
    }
    if(pageKey === 'ct-manual') {
      setupCTManual();
    }
  }

  // Fetch CSV and parse
  async function fetchCSV(filename) {
    try {
      const res = await fetch(filename);
      if(!res.ok) throw new Error('File not found');
      const text = await res.text();
      return parseCSV(text);
    } catch(e) {
      return [["Error loading file"]];
    }
  }

  // Parse CSV text to array of arrays
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    return lines.map(line => {
      // Split by comma, trim spaces, handle quoted commas if needed
      // Simple split for now
      return line.split(',').map(cell => cell.trim());
    });
  }

  // Render table from array data, with special center alignment for urban col 3 & 4
  function renderTable(data, isUrban) {
    if(!data || data.length === 0) return '<p>Tidak ada data</p>';
    let tableClass = isUrban ? 'urban-table' : '';
    let html = `<table class="${tableClass}"><thead><tr>`;
    data[0].forEach(head => {
      html += `<th>${head}</th>`;
    });
    html += `</tr></thead><tbody>`;
    for(let i=1; i<data.length; i++) {
      html += `<tr>`;
      data[i].forEach(cell => {
        html += `<td>${cell}</td>`;
      });
      html += `</tr>`;
    }
    html += `</tbody></table>`;
    return html;
  }

  // CT Dengan Gambar setup
  function setupCTGambar() {
    const uploadInput = document.getElementById('upload-image');
    const ocrProcess = document.getElementById('ocr-process');
    const searchResult = document.getElementById('search-result');
    const previewImage = document.getElementById('preview-image');
    const btnSend = document.getElementById('btn-send-whatsapp');
    let nomerMeter = '';
    let nomerG = '';

    btnSend.disabled = true;
    btnSend.onclick = () => {
      if(!nomerMeter || !nomerG) return alert('Nomor meter atau nomor G belum ditemukan.');
      const message = `FORMAT PERMINTAAN CLEAR TEMPER\n\nID Pelanggan/Nomor Meter : ${nomerMeter}\nNomor gangguan/PK : ${nomerG}\nKeterangan: kwh meter periksa.`;
      const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');
    };

    uploadInput.onchange = () => {
      const file = uploadInput.files[0];
      if(!file) return;
      previewImage.src = URL.createObjectURL(file);
      ocrProcess.textContent = 'Memproses OCR...';
      searchResult.textContent = '';
      btnSend.disabled = true;
      nomerMeter = '';
      nomerG = '';

      Tesseract.recognize(
        file,
        'ind',
        { logger: m => {
          ocrProcess.textContent = `OCR Progress: ${Math.round(m.progress * 100)}%`;
        }}
      ).then(({ data: { text } }) => {
        ocrProcess.textContent = 'OCR selesai. Mencari nomor meter dan nomor G...';
        // Cari nomor meter: angka berawalan 52205 (angka bisa lebih panjang)
        const meterMatch = text.match(/52205\d*/g);
        nomerMeter = meterMatch ? meterMatch[0] : '';
        // Cari nomor G: huruf G diikuti angka
        const gMatch = text.match(/G\d+/gi);
        nomerG = gMatch ? gMatch[0] : '';
        let resultText = `Nomor Meter: ${nomerMeter || 'Tidak ditemukan'}\nNomor G: ${nomerG || 'Tidak ditemukan'}`;
        searchResult.textContent = resultText;
        btnSend.disabled = !(nomerMeter && nomerG);
      }).catch(e => {
        ocrProcess.textContent = 'OCR gagal: ' + e.message;
      });
    };
  }

  // CT Manual setup
  function setupCTManual() {
    const btnSend = document.getElementById('btn-send-whatsapp-manual');
    btnSend.onclick = () => {
      const meter = document.getElementById('input-meter').value.trim();
      const g = document.getElementById('input-g').value.trim();
      if(!meter || !g) {
        alert('Mohon isi Nomor Meter dan Nomor G');
        return;
      }
      const message = `FORMAT PERMINTAAN CLEAR TEMPER\n\nID Pelanggan/Nomor Meter : ${meter}\nNomor gangguan/PK : ${g}\nKeterangan: kwh meter periksa.`;
      const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(url, '_blank');
    };
  }

  // Load default page
  loadPage('patroli');
</script>
</body>
</html>
